<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="LUMORA - Advanced AI Assistant powered by Cohere & Firebase" />
  <title>LUMORA - Advanced AI Assistant</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --glass: rgba(255,255,255,0.04);
      --accent1: #6e48aa; --accent2:#4776E6; --muted:#94a3b8; --white: #e6eef8;
      --success:#10b981; --danger:#ef4444; --shadow: 0 10px 30px rgba(2,6,23,0.6);
      --radius:14px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,#071024 0%, #07182b 60%);
      color:var(--white);
      -webkit-font-smoothing:antialiased;
      display:flex;flex-direction:column;min-height:100vh;
    }

    /* Top bar */
    header{display:flex;align-items:center;justify-content:space-between;padding:18px 28px;background:transparent}
    .brand{display:flex;gap:12px;align-items:center}
    .brand .logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--accent2),var(--accent1));display:flex;align-items:center;justify-content:center;font-weight:800;box-shadow:0 8px 30px rgba(78,52,175,0.25)}
    .brand h1{font-size:18px;letter-spacing:0.6px}

    .top-actions{display:flex;gap:10px;align-items:center}
    .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
    .btn-primary{background:linear-gradient(90deg,var(--accent2),var(--accent1));color:white;box-shadow:var(--shadow)}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--white)}

    /* Layout */
    .container{display:flex;gap:22px;max-width:1200px;margin:22px auto;flex:1;width:100%;padding:0 20px}
    .sidebar{width:300px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);height:calc(100vh - 160px);overflow:auto}
    .main{flex:1;display:flex;flex-direction:column;gap:18px}

    /* Chat card */
    .chat-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:var(--radius);padding:12px;box-shadow:var(--shadow);height:calc(100vh - 160px);display:flex;flex-direction:column}
    .chat-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.03)}
    .chat-header .left{display:flex;align-items:center;gap:12px}
    .user-badge{background:transparent;border-radius:999px;padding:6px 12px;border:1px solid rgba(255,255,255,0.04);font-weight:600;color:var(--white)}

    .messages{flex:1;padding:20px;overflow:auto;display:flex;flex-direction:column;gap:14px}
    .msg{max-width:70%;padding:12px 16px;border-radius:14px;line-height:1.45}
    .msg.bot{background:linear-gradient(180deg,#0b1220,#0f1724);align-self:flex-start;border:1px solid rgba(255,255,255,0.03)}
    .msg.user{background:linear-gradient(90deg,var(--accent2),var(--accent1));color:white;align-self:flex-end}
    .time{display:block;font-size:12px;color:var(--muted);margin-top:8px;text-align:right}

    .input-area{padding:14px;border-top:1px solid rgba(255,255,255,0.03);display:flex;gap:10px;align-items:center}
    .input{flex:1;padding:12px 14px;border-radius:12px;border:none;background:rgba(255,255,255,0.02);color:var(--white);outline:none}
    .send{width:52px;height:52px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--accent2),var(--accent1));display:flex;align-items:center;justify-content:center}

    /* Sidebar items */
    .sidebar h3{margin-bottom:12px;color:var(--muted);font-size:13px}
    .history-item{padding:12px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.02);margin-bottom:10px;cursor:pointer}
    .history-item.active{background:linear-gradient(90deg,var(--accent2),var(--accent1));color:white}

    /* Auth modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:none;align-items:center;justify-content:center;z-index:10000}
    .modal{width:380px;background:linear-gradient(180deg,#071124,#0b1220);padding:22px;border-radius:14px;border:1px solid rgba(255,255,255,0.03)}
    .modal h2{margin-bottom:10px}
    .field{margin-bottom:10px}
    .field input{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--white)}
    .small{font-size:13px;color:var(--muted)}
    .link-like{color:var(--accent2);cursor:pointer}

    /* Notification toast */
    .toast{position:fixed;right:20px;bottom:24px;background:#061223;padding:12px 16px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);display:none}

    footer{padding:18px;text-align:center;color:var(--muted);font-size:13px}

    @media(max-width:900px){.container{flex-direction:column}.sidebar{width:100%;height:auto}.chat-card{height:calc(100vh - 220px)}}
  </style>
</head>
<body>

  <header>
    <div class="brand">
      <div class="logo">L</div>
      <div>
        <h1>LUMORA</h1>
        <div class="small">Advanced AI Assistant</div>
      </div>
    </div>

    <div class="top-actions">
      <button class="btn btn-ghost" id="btn-register">Register</button>
      <button class="btn btn-primary" id="btn-login">Login</button>
    </div>
  </header>

  <main class="container">
    <aside class="sidebar">
      <h3>Chat History</h3>
      <div id="chat-history">
        <div class="history-item active">Today</div>
      </div>
      <div style="height:12px"></div>
      <div class="small">Tip: You can chat as a guest. Uploads and account features require login.</div>
    </aside>

    <section class="main">
      <div class="chat-card" role="region" aria-label="Chat">
        <div class="chat-header">
          <div class="left">
            <i class="fas fa-robot" style="font-size:20px;color:var(--accent2)"></i>
            <div>
              <div style="font-weight:700">LUMORA AI Assistant</div>
              <div class="small">Fast, helpful and respectful</div>
            </div>
          </div>

          <div>
            <span class="user-badge" id="user-badge">Guest</span>
            <button class="btn btn-ghost" id="logout-btn" style="margin-left:10px;display:none">Sign out</button>
          </div>
        </div>

        <div class="messages" id="chat-messages">
          <div class="msg bot">👋 Hello! I'm LUMORA. Start by typing your question below.<span class="time">Just now</span></div>
        </div>

        <div class="input-area">
          <button class="btn btn-ghost" id="upload-btn" title="Upload files (login required)"><i class="fas fa-paperclip"></i></button>
          <input class="input" id="chat-input" placeholder="Type your message here..." aria-label="Chat input" />
          <button class="send" id="send-btn"><i class="fas fa-paper-plane"></i></button>
        </div>
      </div>
    </section>
  </main>

  <footer>From AITECH by ANOINTING • Powered by Cohere AI • © 2023–2025 LUMORA</footer>

  <!-- Auth Modal -->
  <div class="modal-backdrop" id="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="auth-title">
      <h2 id="auth-title">Login</h2>

      <div id="auth-forms">
        <!-- dynamic content inserted here -->
      </div>

      <div style="display:flex;justify-content:space-between;margin-top:10px">
        <div class="small" id="auth-helper"></div>
        <div><button class="btn btn-ghost" id="close-modal">Close</button></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // --------- CONFIG ----------
    const COHERE_API_KEY = "NMGQyIAUHmb861NWLZW2iDHik3Vui8No6dLxj7Gs"; // user-provided

    const firebaseConfig = {
      apiKey: "AIzaSyBOwdgpt4PSo_MLMmz716zswPnpInaXfok",
      authDomain: "lumora-b227c.firebaseapp.com",
      projectId: "lumora-b227c",
      storageBucket: "lumora-b227c.firebasestorage.app",
      messagingSenderId: "126529099616",
      appId: "1:126529099616:web:303e8d8c987ecd6ba1b005",
      measurementId: "G-83DKQ20SV8"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // --------- ELEMENTS ----------
    const btnLogin = document.getElementById('btn-login');
    const btnRegister = document.getElementById('btn-register');
    const modalBackdrop = document.getElementById('modal-backdrop');
    const authForms = document.getElementById('auth-forms');
    const authTitle = document.getElementById('auth-title');
    const closeModalBtn = document.getElementById('close-modal');
    const toast = document.getElementById('toast');

    const userBadge = document.getElementById('user-badge');
    const logoutBtn = document.getElementById('logout-btn');
    const uploadBtn = document.getElementById('upload-btn');

    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');

    // --------- Helpers ----------
    function showToast(message, timeout = 4500) {
      toast.textContent = message; toast.style.display = 'block';
      setTimeout(()=> toast.style.display = 'none', timeout);
    }

    function openModal(mode = 'login'){
      modalBackdrop.style.display = 'flex';
      renderAuth(mode);
    }

    function closeModal(){ modalBackdrop.style.display = 'none'; }

    closeModalBtn.addEventListener('click', closeModal);
    modalBackdrop.addEventListener('click', (e)=>{ if(e.target===modalBackdrop) closeModal(); });

    btnLogin.addEventListener('click', ()=>openModal('login'));
    btnRegister.addEventListener('click', ()=>openModal('register'));

    // Render auth forms dynamically so labels are consistent
    function renderAuth(mode){
      authForms.innerHTML = '';
      if(mode === 'login'){
        authTitle.textContent = 'Login to LUMORA';
        authForms.innerHTML = `
          <div class="field"><input id="email" placeholder="Email" type="email" /></div>
          <div class="field"><input id="password" placeholder="Password" type="password" /></div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div class="small">Don't have an account? <span class="link-like" id="goto-register">Register</span></div>
            <button class="btn btn-primary" id="login-submit">Login</button>
          </div>
          <div class="small">Forgot password? <span class="link-like" id="reset-password">Reset</span></div>
        `;
      } else {
        authTitle.textContent = 'Create your account';
        authForms.innerHTML = `
          <div class="field"><input id="displayName" placeholder="Full name" type="text" /></div>
          <div class="field"><input id="email" placeholder="Email" type="email" /></div>
          <div class="field"><input id="password" placeholder="Password (6+ chars)" type="password" /></div>
          <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:6px">
            <button class="btn btn-ghost" id="goto-login">Already have account</button>
            <button class="btn btn-primary" id="register-submit">Register</button>
          </div>
        `;
      }

      // bind actions
      document.getElementById('goto-login')?.addEventListener('click', ()=>renderAuth('login'));
      document.getElementById('goto-register')?.addEventListener('click', ()=>renderAuth('register'));
      document.getElementById('reset-password')?.addEventListener('click', async ()=>{
        const email = document.getElementById('email')?.value?.trim();
        if(!email) return showToast('Enter your email in the form to reset password.');
        try{ await auth.sendPasswordResetEmail(email); showToast('Password reset sent. Check inbox or spam.'); }
        catch(e){ showToast(e.message || 'Failed to send reset email.'); }
      });

      document.getElementById('login-submit')?.addEventListener('click', async ()=>{
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        if(!email || !password) return showToast('Please fill email and password.');
        try{
          const credential = await auth.signInWithEmailAndPassword(email, password);
          // after sign in, check verification
          if(!credential.user.emailVerified){
            // show professional verification modal
            closeModal();
            await promptEmailVerification(credential.user);
            return;
          }
          // successful and verified
          showToast('Welcome back! Redirecting...');
          // redirect to home (as requested)
          window.location.href = 'home.html';
        } catch(e){ showToast(e.message || 'Login failed'); }
      });

      document.getElementById('register-submit')?.addEventListener('click', async ()=>{
        const name = document.getElementById('displayName').value.trim();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        if(!name || !email || !password) return showToast('Please fill all fields.');
        try{
          const result = await auth.createUserWithEmailAndPassword(email, password);
          await result.user.updateProfile({ displayName: name });
          await db.collection('users').doc(result.user.uid).set({ displayName: name, email, createdAt: new Date() });
          await result.user.sendEmailVerification();
          closeModal();
          // Show professional message
          await promptEmailVerification(result.user, true);
        } catch(e){ showToast(e.message || 'Registration failed.'); }
      });
    }

    async function promptEmailVerification(user, afterRegister=false){
      // professional modal informing the user to verify
      modalBackdrop.style.display = 'flex';
      authTitle.textContent = 'Email verification required';
      authForms.innerHTML = `
        <div style="margin-bottom:10px">
          <div class="small" style="color:var(--muted)">A verification email has been sent to:</div>
          <div style="font-weight:700;margin-top:6px">${user.email}</div>
        </div>
        <div class="small" style="margin-bottom:12px">To complete account activation, open the message from <em>no-reply@firebaseapp.com</em> (or similar), and click the verification link. If you can't find it, please check your spam or promotions folder.</div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button class="btn btn-ghost" id="verify-done">I verified</button>
          <button class="btn btn-primary" id="resend-verif">Resend verification email</button>
        </div>
      `;

      document.getElementById('resend-verif').addEventListener('click', async ()=>{
        try{
          await user.sendEmailVerification();
          showToast('Verification email resent. Check inbox or spam.');
        }catch(e){ showToast(e.message || 'Could not resend verification.'); }
      });

      document.getElementById('verify-done').addEventListener('click', async ()=>{
        await user.reload();
        if(user.emailVerified){ showToast('Email verified! Redirecting...'); window.location.href = 'home.html'; }
        else showToast('We still cannot detect verification. Please click the link in the email and then press "I verified".');
      });

      if(afterRegister) showToast('A verification email was sent. Please verify to access full features.');
    }

    // Global auth state listener
    auth.onAuthStateChanged(user=>{
      if(user){
        userBadge.textContent = user.displayName || user.email.split('@')[0] || 'User';
        logoutBtn.style.display = 'inline-block';
        btnLogin.style.display = 'none';
        btnRegister.style.display = 'none';
      } else {
        userBadge.textContent = 'Guest';
        logoutBtn.style.display = 'none';
        btnLogin.style.display = 'inline-block';
        btnRegister.style.display = 'inline-block';
      }
    });

    logoutBtn.addEventListener('click', ()=>{
      auth.signOut().then(()=> showToast('Signed out.')).catch(e=> showToast(e.message));
    });

    // Upload button: requires login
    uploadBtn.addEventListener('click', ()=>{
      if(!auth.currentUser){ openModal('login'); showToast('Please login or register to upload files.'); return; }
      if(!auth.currentUser.emailVerified){ openModal('login'); showToast('Please verify your email before uploading.'); return; }
      // If reached, show file selector (we'll create an input on demand)
      const input = document.createElement('input'); input.type='file'; input.onchange = async (e)=>{
        const file = e.target.files[0]; if(!file) return;
        const ref = storage.ref(`uploads/${auth.currentUser.uid}/${Date.now()}_${file.name}`);
        try{ const snap = await ref.put(file); const url = await snap.ref.getDownloadURL(); addMessage(`📎 Uploaded: ${file.name}`, 'user'); addMessage('File uploaded. Ask me about it!', 'bot'); }
        catch(err){ addMessage('❌ Upload failed: '+(err.message||''),'bot'); }
      };
      input.click();
    });

    // Chat send handling - Guests can chat
    function addMessage(text, sender='bot'){
      const el = document.createElement('div'); el.className = 'msg ' + (sender==='user'?'user':'bot');
      el.innerHTML = `<div>${escapeHtml(text)}</div><span class="time">${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>`;
      chatMessages.appendChild(el); chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function escapeHtml(s){ return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    async function askCohere(message){
      try{
        const res = await fetch('https://api.cohere.ai/v1/chat',{
          method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${COHERE_API_KEY}`},
          body: JSON.stringify({ model: 'command-r', message })
        });
        const data = await res.json();
        // Cohere returns various shapes; try to be resilient
        return data.text || data.output?.[0]?.content || JSON.stringify(data);
      }catch(e){ console.error(e); return '⚠️ AI temporarily unavailable.'; }
    }

    async function handleSend(){
      const text = chatInput.value.trim(); if(!text) return;
      addMessage(text,'user'); chatInput.value='';
      // show typing
      const typing = document.createElement('div'); typing.className='msg bot'; typing.innerHTML = '<em>Thinking…</em><span class="time">&nbsp;</span>'; chatMessages.appendChild(typing); chatMessages.scrollTop = chatMessages.scrollHeight;
      const reply = await askCohere(text);
      typing.remove(); addMessage(reply,'bot');
    }

    sendBtn.addEventListener('click', handleSend);
    chatInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') handleSend(); });

    // Small UX: Preload history
    function loadChatHistory(){ const h = document.getElementById('chat-history'); h.innerHTML=''; const item = document.createElement('div'); item.className='history-item active'; item.textContent='Today'; h.appendChild(item); }
    loadChatHistory();

    // If user is already logged in and verified on page load -> redirect to home directly
    auth.onAuthStateChanged(async (u)=>{
      if(u && u.emailVerified){
        // If explicit redirect desired (user requested), go to home.html
        // Commented out to avoid surprise; uncomment if you want automatic redirect
        // window.location.href = 'home.html';
      }
    });

  </script>
</body>
</html>
