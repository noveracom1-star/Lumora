<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="LUMORA - Advanced AI Assistant Dashboard" />
  <title>LUMORA - Dashboard</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --glass: rgba(255,255,255,0.04);
      --accent1: #6e48aa; --accent2:#4776E6; --muted:#94a3b8; --white: #e6eef8;
      --success:#10b981; --danger:#ef4444; --shadow: 0 10px 30px rgba(2,6,23,0.6);
      --radius:14px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,#071024 0%, #07182b 60%);
      color:var(--white);
      display:flex;flex-direction:column;min-height:100vh;
    }

    /* Top bar */
    header{display:flex;align-items:center;justify-content:space-between;padding:18px 28px;background:transparent; border-bottom:1px solid rgba(255,255,255,0.05);}
    .brand{display:flex;gap:12px;align-items:center}
    .brand .logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--accent2),var(--accent1));display:flex;align-items:center;justify-content:center;font-weight:800;box-shadow:0 8px 30px rgba(78,52,175,0.25)}
    .brand h1{font-size:18px;letter-spacing:0.6px}

    .top-actions{display:flex;gap:10px;align-items:center}
    .profile-btn{width:46px;height:46px;border-radius:50%;border:none;background:linear-gradient(135deg,var(--accent2),var(--accent1));display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;box-shadow:var(--shadow);}
    .logout-btn{padding:8px 12px;border-radius:10px;border:none;background:var(--danger);color:white;cursor:pointer;font-weight:600;box-shadow:var(--shadow)}

    /* Layout */
    .container{display:flex;gap:22px;max-width:1400px;margin:22px auto;flex:1;width:100%;padding:0 20px}
    .sidebar{width:300px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);height:calc(100vh - 100px);overflow:auto;display:flex;flex-direction:column}
    .main{flex:1;display:flex;flex-direction:column;gap:18px}

    /* Sidebar items */
    .sidebar h3{margin-bottom:12px;color:var(--muted);font-size:13px;text-transform:uppercase}
    .history-item{padding:12px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.02);margin-bottom:10px;cursor:pointer;transition:0.2s}
    .history-item:hover{background:linear-gradient(90deg,var(--accent2),var(--accent1));color:white}
    .history-item.active{background:linear-gradient(90deg,var(--accent2),var(--accent1));color:white}
    .chat-controls{margin-bottom:12px;display:flex;gap:10px;flex-wrap:wrap}
    .chat-controls button{flex:1;padding:10px 12px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent2),var(--accent1));color:white;cursor:pointer;font-weight:600;transition:0.2s}
    .chat-controls button:hover{opacity:0.9}

    /* Chat card */
    .chat-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:var(--radius);padding:12px;box-shadow:var(--shadow);height:calc(100vh - 100px);display:flex;flex-direction:column}
    .chat-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.03)}
    .chat-header .left{display:flex;align-items:center;gap:12px}
    .messages{flex:1;padding:20px;overflow:auto;display:flex;flex-direction:column;gap:14px}
    .msg{max-width:70%;padding:12px 16px;border-radius:14px;line-height:1.45;word-wrap:break-word}
    .msg.bot{background:linear-gradient(180deg,#0b1220,#0f1724);align-self:flex-start;border:1px solid rgba(255,255,255,0.03)}
    .msg.user{background:linear-gradient(90deg,var(--accent2),var(--accent1));color:white;align-self:flex-end}
    .time{display:block;font-size:12px;color:var(--muted);margin-top:8px;text-align:right}
    .input-area{padding:14px;border-top:1px solid rgba(255,255,255,0.03);display:flex;gap:10px;align-items:center}
    .input{flex:1;padding:12px 14px;border-radius:12px;border:none;background:rgba(255,255,255,0.02);color:var(--white);outline:none}
    .send{width:52px;height:52px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--accent2),var(--accent1));display:flex;align-items:center;justify-content:center;cursor:pointer}

    footer{padding:18px;text-align:center;color:var(--muted);font-size:13px}

    @media(max-width:1100px){.container{flex-direction:column}.sidebar{width:100%;height:auto}.chat-card{height:calc(100vh - 220px)}}
  </style>
</head>
<body>

  <header>
    <div class="brand">
      <div class="logo">L</div>
      <div>
        <h1>LUMORA</h1>
        <div class="small">Advanced AI Assistant</div>
      </div>
    </div>

    <div class="top-actions">
      <button class="profile-btn" id="profile-btn" title="Profile"><i class="fas fa-user"></i></button>
      <button class="logout-btn" id="logout-btn">Logout</button>
    </div>
  </header>

  <main class="container">
    <aside class="sidebar">
      <h3>Chat History</h3>
      <div id="chat-history"></div>
      <div class="chat-controls">
        <button id="new-chat-btn">New Chat</button>
        <button id="temp-chat-btn">Temporary Chat</button>
      </div>
    </aside>

    <section class="main">
      <div class="chat-card" role="region" aria-label="Chat">
        <div class="chat-header">
          <div class="left">
            <i class="fas fa-robot" style="font-size:20px;color:var(--accent2)"></i>
            <div>
              <div style="font-weight:700">LUMORA AI Assistant</div>
              <div class="small">Fast, helpful and respectful</div>
            </div>
          </div>
        </div>

        <div class="messages" id="chat-messages">
          <div class="msg bot">üëã Hello! I'm LUMORA. Start by typing your question below.<span class="time">Just now</span></div>
        </div>

        <div class="input-area">
          <button class="btn btn-ghost" id="upload-btn" title="Upload files/photos"><i class="fas fa-paperclip"></i></button>
          <input class="input" id="chat-input" placeholder="Type your message here..." aria-label="Chat input" />
          <button class="send" id="send-btn"><i class="fas fa-paper-plane"></i></button>
        </div>
      </div>
    </section>
  </main>

  <footer>From AITECH by ANOINTING ‚Ä¢ Powered by Cohere AI ‚Ä¢ ¬© 2023‚Äì2025 LUMORA</footer>

  <div class="toast" id="toast"></div>

  <script>
    const COHERE_API_KEY = "NMGQyIAUHmb861NWLZW2iDHik3Vui8No6dLxj7Gs";
    const firebaseConfig = {
      apiKey: "AIzaSyBOwdgpt4PSo_MLMmz716zswPnpInaXfok",
      authDomain: "lumora-b227c.firebaseapp.com",
      projectId: "lumora-b227c",
      storageBucket: "lumora-b227c.firebasestorage.app",
      messagingSenderId: "126529099616",
      appId: "1:126529099616:web:303e8d8c987ecd6ba1b005"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const toast = document.getElementById('toast');
    const chatHistoryEl = document.getElementById('chat-history');
    const uploadBtn = document.getElementById('upload-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const profileBtn = document.getElementById('profile-btn');
    const newChatBtn = document.getElementById('new-chat-btn');
    const tempChatBtn = document.getElementById('temp-chat-btn');

    let currentChatId = null;

    function showToast(msg, time=4000){ toast.textContent = msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none',time); }
    function escapeHtml(s){ return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    function addMessage(text, sender='bot'){
      const el = document.createElement('div'); el.className = 'msg ' + (sender==='user'?'user':'bot');
      el.innerHTML = `<div>${escapeHtml(text)}</div><span class="time">${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>`;
      chatMessages.appendChild(el); chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function askCohere(message){
      try{
        const res = await fetch('https://api.cohere.ai/v1/chat',{
          method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${COHERE_API_KEY}`},
          body: JSON.stringify({ model: 'command-r', message })
        });
        const data = await res.json();
        return data.text || data.output?.[0]?.content || '‚ö†Ô∏è AI temporarily unavailable.';
      }catch(e){ console.error(e); return '‚ö†Ô∏è AI temporarily unavailable.'; }
    }

    async function handleSend(){
      const text = chatInput.value.trim(); if(!text) return;
      addMessage(text,'user'); chatInput.value='';
      const typing = document.createElement('div'); typing.className='msg bot'; typing.innerHTML = '<em>Thinking‚Ä¶</em><span class="time">&nbsp;</span>';
      chatMessages.appendChild(typing); chatMessages.scrollTop=chatMessages.scrollHeight;
      const reply = await askCohere(text);
      typing.remove(); addMessage(reply,'bot');
      // Save to Firestore
      if(currentChatId){
        db.collection('chats').doc(currentChatId).collection('messages').add({ text, sender:'user', timestamp:new Date() });
        db.collection('chats').doc(currentChatId).collection('messages').add({ text:reply, sender:'bot', timestamp:new Date() });
      }
    }

    sendBtn.addEventListener('click', handleSend);
    chatInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') handleSend(); });

    // Upload files/photos
    uploadBtn.addEventListener('click', ()=>{
      const input = document.createElement('input'); input.type='file'; input.accept='image/*,application/pdf'; input.onchange=async(e)=>{
        const file = e.target.files[0]; if(!file) return;
        const ref = storage.ref(`uploads/${auth.currentUser.uid}/${Date.now()}_${file.name}`);
        try{
          const snap = await ref.put(file); const url = await snap.ref.getDownloadURL();
          addMessage(`üìé Uploaded: ${file.name}`, 'user'); addMessage(`File uploaded. You can ask me about it!`, 'bot');
          if(currentChatId){
            db.collection('chats').doc(currentChatId).collection('messages').add({ text:`Uploaded: ${file.name} - ${url}`, sender:'user', timestamp:new Date() });
          }
        }catch(err){ addMessage('‚ùå Upload failed: '+(err.message||''),'bot'); }
      }; input.click();
    });

    // Load chat history
    async function loadChatHistory(){
      chatHistoryEl.innerHTML=''; currentChatId=null;
      const chats = await db.collection('chats').where('userId','==',auth.currentUser.uid).orderBy('createdAt','desc').get();
      chats.forEach(doc=>{
        const item = document.createElement('div'); item.className='history-item'; item.textContent = doc.data().title || 'Chat';
        item.addEventListener('click', ()=>openChat(doc.id,item));
        chatHistoryEl.appendChild(item);
      });
    }

    async function openChat(chatId, itemEl){
      currentChatId = chatId;
      document.querySelectorAll('.history-item').forEach(el=>el.classList.remove('active'));
      itemEl.classList.add('active');
      chatMessages.innerHTML='';
      const msgs = await db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp').get();
      msgs.forEach(m=>addMessage(m.data().text,m.data().sender));
    }

    newChatBtn.addEventListener('click', async ()=>{
      const doc = await db.collection('chats').add({ userId: auth.currentUser.uid, createdAt:new Date(), title:'New Chat' });
      await loadChatHistory();
    });

    tempChatBtn.addEventListener('click', ()=>{
      chatMessages.innerHTML=''; currentChatId=null; showToast('Temporary chat started (not saved).');
    });

    // Profile & Logout
    profileBtn.addEventListener('click', ()=>{ window.location.href='profile.html'; });
    logoutBtn.addEventListener('click', ()=>{ auth.signOut().then(()=> window.location.href='index.html'); });

    auth.onAuthStateChanged(u=>{
      if(!u){ window.location.href='index.html'; return; }
      loadChatHistory();
    });
  </script>
</body>
</html>
